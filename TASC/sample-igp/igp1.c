#include "graphics.h"
#include "extgraph.h"
#include "genlib.h"
#include "simpio.h"
#include "conio.h"
#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>
#include <windows.h>
#include <olectl.h>
#include <mmsystem.h>
#include <wingdi.h>
#include <ole2.h>
#include <ocidl.h>
#include <winuser.h>

#define deltax 0.03
#define deltay 0.03

#define TIMER_BLINK500  1     /*500ms定时器事件标志号*/
#define TIMER_BLINK1000 2     /*1000ms定时器时间标志号*/

const int mseconds500 = 500;   
const int mseconds1000 = 1000; 

static double ccx = 1.0, ccy = 1.0;/*圆心坐标*/
static double radius = 1.0; /*圆半径*/

static char text[100]; /*输入的字符串缓冲区*/
static int textlen = 0;/*输入的字符串长度*/
static double textx, texty; /*字符串的起始位置*/

static bool isBlink = FALSE;   /*是否闪烁标志*/
static bool isDisplayText = FALSE; /*字符串显示标志*/
static bool isDisplayCircle = TRUE; /*圆显示标志*/

void DrawCenteredCircle(double x, double y, double r);/*画中心圆*/
/*判断点(x0,y0)是否在矩形包围盒(x1, y1) --> (x2, y2)范围内*/
bool inBox(double x0, double y0, double x1, double x2, double y1, double y2);

void KeyboardEventProcess(int key,int event);/*键盘消息回调函数*/
void CharEventProcess(char c);/*字符消息回调函数*/
void MouseEventProcess(int x, int y, int button, int event);/*鼠标消息回调函数*/
void TimerEventProcess(int timerID);/*定时器消息回调函数*/

void Main() /*仅初始化执行一次*/
{
    InitGraphics();        	
	
	registerKeyboardEvent(KeyboardEventProcess);/*注册键盘消息回调函数*/
	registerCharEvent(CharEventProcess);/*注册字符消息回调函数*/
	registerMouseEvent(MouseEventProcess);/*注册鼠标消息回调函数*/
	registerTimerEvent(TimerEventProcess);/*注册定时器消息回调函数*/

	SetPenColor("Red"); 
    SetPenSize(1);
    
    ccx = GetWindowWidth()/2;
    ccy = GetWindowHeight()/2;
    DrawCenteredCircle(ccx, ccy, radius);
}

void DrawCenteredCircle(double x, double y, double r)
{
    MovePen(x + r, y);
    DrawArc(r, 0.0, 360.0);
}

void Save2File(char *filename, char *text)
{
	FILE *fp;
	
	fp = fopen(filename, "a");
	fprintf(fp, "%s\n", text);
	fclose(fp);
	return;
} 

void DisplayInfo(double x, double y, char *text)
{
	static char buf[100] = {0};
	int ox, oy;
	ox = GetCurrentX(); oy = GetCurrentY();
	MovePen(x, y);
	SetEraseMode(TRUE);
	DrawTextString(buf);
	MovePen(x, y);
	SetEraseMode(FALSE);
	strcpy(buf, text);
	DrawTextString(buf);
	MovePen(ox, oy);
	
	return;
} 

void KeyboardEventProcess(int key,int event)/*每当产生键盘消息，都要执行*/
{
 	 double oldradius;

     switch (event) {
	 	case KEY_DOWN:
			 switch (key) { 
			     case VK_UP:/*UP*/
			         SetEraseMode(TRUE);/*擦除前一个*/
                     DrawCenteredCircle(ccx, ccy, radius);
					 ccy += deltay;
					 SetEraseMode(FALSE);/*画新的*/
                     DrawCenteredCircle(ccx, ccy, radius);
                     break;
			     case VK_DOWN:
			         SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, radius);
					 ccy -= deltay;
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     break;
			     case VK_LEFT:
			         SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, radius);
					 ccx -= deltax;
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     break;
			     case VK_RIGHT:
			         SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, radius);
					 ccx += deltax;
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     break;
			     case VK_F1:
  					 SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, radius);
		 	         SetPenSize(GetPenSize()+1);
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
					 break;
			     case VK_F2:
  					 SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, radius);
		 	         SetPenSize(GetPenSize()-1);
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     break;
			     case VK_F3:
			     case VK_PRIOR:
	 	     		 SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     radius += 0.1;
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     break;
			     case VK_F4:
			     case VK_NEXT:
		 	         SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     radius -= 0.1;
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     break;
			     case VK_F9:
			         InitConsole();
			         oldradius = radius;
			         printf("Input radius: ");
			         radius = GetReal();
			         FreeConsole();
  					 SetEraseMode(TRUE);
                     DrawCenteredCircle(ccx, ccy, oldradius);
					 SetEraseMode(FALSE);
                     DrawCenteredCircle(ccx, ccy, radius);
                     
                     break;
			     case VK_ESCAPE:/*打开或关闭定时器*/
                     isBlink = !isBlink;
                     if (isBlink ) {
						startTimer(TIMER_BLINK500, mseconds500);/*500ms定时器触发*/
						startTimer(TIMER_BLINK1000, mseconds1000);/*1000ms定时器触发*/
                     } else {
						cancelTimer(TIMER_BLINK500);/*500ms定时器关闭*/
    					cancelTimer(TIMER_BLINK1000);/*500ms定时器关闭*/
					 }
                     break;
			 }
			 break;
		case KEY_UP:
			 break;
	 }	 
}

void CharEventProcess(char c)
{
 	 static char str[2] = {0, 0};

     switch (c) {
       case '\r':  /* 注意：回车在这里返回的字符是'\r'，不是'\n'*/
		   isDisplayText = TRUE;/*设置字符串显示标志*/
           textx = GetCurrentX()-TextStringWidth(text);/*设置字符串的起始坐标*/
		   texty = GetCurrentY();
   	 	   break;
 	   case 27: /*ESC*/
 	       break;
      default:
	  	   str[0] = c;/*形成当前字符的字符串*/
	 	   text[textlen++] = c;/*将当前字符加入到整个字符缓冲区中*/
	 	   text[textlen] = '\0';
	 	   DrawTextString(str);/*输出当前字符，且输出位置相应后移*/
	 	   break;
    }
}

bool inBox(double x0, double y0, double x1, double x2, double y1, double y2)
{
	return (x0 >= x1 && x0 <= x2 && y0 >= y1 && y0 <= y2);
}

void MouseEventProcess(int x, int y, int button, int event)
{
 	 static bool isMoveCircle = FALSE;/*移动圆标志*/
 	 static bool isMoveText = FALSE; /*移动文本标志*/ 
	 static bool isChangeRadius = FALSE;/*改变圆半径标志*/
 	 static double omx, omy;
     double mx, my;
/*
	 {
	 	char text[100];
	 	sprintf(text, "button = %d, event = %d", button, event);
	 	DisplayInfo(0.1, 0.1, text);
	 }
*/	 
 	 mx = ScaleXInches(x);/*pixels --> inches*/
 	 my = ScaleYInches(y);/*pixels --> inches*/

     switch (event) {
         case BUTTON_DOWN:
   		 	  if (button == LEFT_BUTTON) {
				  if (inBox(mx, my, ccx-radius, ccx+radius, ccy-radius, ccy+radius)){
					  isMoveCircle = TRUE;
				  } else if (inBox(mx, my, textx, textx+TextStringWidth(text), 
				                           texty, texty+GetFontHeight())){
				  	  isMoveText = TRUE;
				  }
			  } else if (button == RIGHT_BUTTON && inBox(mx, my, ccx-radius, ccx+radius, ccy-radius, ccy+radius)) {
				  isChangeRadius = TRUE;
			  }
		      omx = mx; omy = my;
              break;
    	 case BUTTON_DOUBLECLICK:
			  break;
         case BUTTON_UP:
  		 	  if (button == LEFT_BUTTON) {
  		 	  	isMoveCircle = FALSE;
  		 	  	isMoveText = FALSE;
  		 	  }else if (button == RIGHT_BUTTON) {
  		 	  	isChangeRadius = FALSE;
  		 	  } 
              break;
         case MOUSEMOVE:
			  if (isMoveCircle) {
                  SetEraseMode(TRUE);/*擦除前一个*/
				  DrawCenteredCircle(ccx, ccy, radius);
				  SetEraseMode(FALSE);/*画新的*/
				  MovePen(textx, texty);/*起始位置*/
				  DrawTextString(text);
                  ccx += mx - omx;
				  ccy += my - omy;
				  omx = mx;
				  omy = my;
                  DrawCenteredCircle(ccx, ccy, radius);
			  } else if (isChangeRadius) {
                  SetEraseMode(TRUE);/*擦除前一个*/
                  DrawCenteredCircle(ccx, ccy, radius);
				  SetEraseMode(FALSE);/*画新的*/
                  MovePen(textx, texty);/*起始位置*/
				  DrawTextString(text);
				  radius += mx - omx;
				  omx = mx;
				  omy = my;
                  DrawCenteredCircle(ccx, ccy, radius);
			  } else if (isMoveText) {
					SetEraseMode(TRUE);
	          		MovePen(textx, texty);/*起始位置*/
					DrawTextString(text);
					SetEraseMode(FALSE);
	                DrawCenteredCircle(ccx, ccy, radius);
	 				textx += mx - omx;
					texty += my - omy;
					omx = mx;
					omy = my;				
					MovePen(textx, texty);/*起始位置*/
					DrawTextString(text);
					break;
			  }
              break;
     }	
}

void TimerEventProcess(int timerID)
{
      bool erasemode;

	  switch (timerID) {
	    case TIMER_BLINK500: /*500ms文本闪烁定时器*/
		  if (!isBlink) return;
	      erasemode = GetEraseMode();
          MovePen(textx, texty);/*起始位置*/
		  SetEraseMode(isDisplayText);/*根据当前显示标志来决定是显示还是隐藏字符串*/
		  DrawTextString(text);/*当前位置会随字符串后移*/
	      SetEraseMode(erasemode);
		  isDisplayText = !isDisplayText;/*交替显示/隐藏字符串符号*/
		  break;
	    case TIMER_BLINK1000: /*1000ms圆闪烁定时器*/
		  if (!isBlink) return;
	      erasemode = GetEraseMode();
		  SetEraseMode(isDisplayCircle);
          DrawCenteredCircle(ccx, ccy, radius);
	      SetEraseMode(erasemode);
		  isDisplayCircle = !isDisplayCircle;
		  break;
	    default:
		  break;
	  }
}
